---

- name: Get the path to the edu-sharing config-cluster docker volume.
  shell: |
    sg docker -c "docker volume inspect --format '{{ '{{' }}.Mountpoint{{ '}}' }}'  $(sg docker -c "docker volume ls -q |grep '_repository-service-volume-config-cluster'")"
  register: repository_volume_config_cluster_path
  ignore_errors: true
  tags:
    - edu-sharing-cluster

- name: Let's wait until all required files are generated by docker container
  become: true
  wait_for:
    path: "{{ item }}"
    state: present
  retries: 10
  delay: 10
  loop:
    - "{{ repository_volume_config_cluster_path.stdout }}/applications/homeApplication.properties.xml"
    - "{{repository_volume_config_cluster_path.stdout}}/applications/ccapp-registry.properties.xml"

- include_tasks: edu-sharing-config-file.yml
  args:
    apply:
      become: yes
  when: (repository_volume_config_cluster_path.stdout is defined) and (repository_volume_config_cluster_path.stdout != "")
  tags:
    - edu-sharing-config-cluster