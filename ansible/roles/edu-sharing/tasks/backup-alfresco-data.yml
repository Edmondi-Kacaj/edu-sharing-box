---

  - name: Ensure tomcat is stopped.
    shell: '{{tomcat_stop_command}}'
    tags:
    - backup-alfresco-data

  - name: Ensures backup_path dir exists
    file: path='{{ backup_path }}' state=directory
    tags:
    - backup-alfresco-data

  - name: Backup alfresco database 
    no_log: true
    shell: |
      PGPASSWORD="{{alfresco_db.password}}" pg_dump -h localhost -U {{alfresco_db.user}}  {{alfresco_db.name}}  --serializable-deferrable | gzip > {{edu_sharing_sql_backup_file}}
    tags:
    - backup-alfresco-data

  - name: Create backup directory for alfresco data.
    archive:
      path: '{{ alf_home}}/alf_data/*'
      dest: '{{ edu_sharing_alfresco_backup_file}}'
      format: gz
    tags:
    - migration-alfresco-data

  - name: Ensure tomcat is started.
    shell: '{{tomcat_start_command}}'
    tags:
    - backup-alfresco-data